<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>25-Piece Puzzle — FINAL WORKING</title>
<style>
  body { margin:0; padding:20px; background:#111; color:#eee; font-family:system-ui; text-align:center; }
  h1 { font-size:1.8em; margin:10px 0; }
  input, button { margin:8px; padding:12px; font-size:16px; border-radius:8px; }
  button { background:#333; color:white; border:2px solid #666; cursor:pointer; }

  .box {
    width:100%; max-width:520px; margin:30px auto;
    aspect-ratio:1/1; border:8px solid #555; border-radius:16px; overflow:hidden;
    box-shadow:0 15px 40px rgba(0,0,0,0.8);
  }
  #puzzle { display:grid; grid-template-columns:repeat(5,1fr); gap:0; }
  .tile-wrapper { position:relative; display:block; }
  canvas { display:block; width:100%; height:100%; }
  canvas:active { transform:scale(0.94); }
  canvas.preview-wrong { box-shadow:0 0 40px 8px yellow !important; }
  canvas.preview-correct { box-shadow:0 0 40px 8px #00ddff !important; }
  canvas.selected { outline:6px solid yellow; transform:scale(0.88) !important; z-index:10; }
  canvas.correct-flash { animation:glow 1s; }
  @keyframes glow { 0%,100% { box-shadow:0 0 40px lime; } 50% { box-shadow:0 0 80px lime; transform:scale(1.1); } }
  
  /* Checkmark overlay for correct pieces */
  .tile-wrapper .checkmark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 4em;
    color: lime;
    text-shadow: 0 0 10px black, 0 0 20px black;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .tile-wrapper:hover .checkmark {
    opacity: 1;
  }
</style>
</head>
<body>

<h1>25-Piece Puzzle</h1>
<p>Tap two pieces • Long-press = preview</p>
<input type="text" id="url" placeholder="Any image URL" value="https://picsum.photos/seed/tiger/900/1400" style="width:90%;">
<button onclick="init()">New Puzzle</button>
<button id="toggleBtn" onclick="toggleView()">View Original</button>

<!-- PUZZLE BOX -->
<div class="box" id="puzzleBox">
  <div id="puzzle"></div>
</div>

<!-- ORIGINAL IMAGE BOX -->
<div class="box" id="originalBox" style="display:none;">
  <img id="originalImg" style="width:100%; height:100%; object-fit:cover; object-position:center;">
</div>

<script>
const GRID = 5;
let tiles = [], selected = null;
const img = new Image();
img.crossOrigin = "anonymous";

function init() {
  const url = document.getElementById('url').value.trim() || 'https://picsum.photos/seed/tiger/900/1400';
  img.src = url + '?t=' + Date.now();

  // Update original view
  document.getElementById('originalImg').src = url;

  img.onload = () => {
    const puzzle = document.getElementById('puzzle');
    puzzle.innerHTML = ''; tiles = [];

    const size = puzzle.offsetWidth || 500;
    const tileSize = size / GRID;

    // Center-crop to square
    const crop = document.createElement('canvas');
    crop.width = crop.height = size;
    const ctx = crop.getContext('2d');
    const scale = Math.max(size / img.width, size / img.height);
    const w = img.width * scale, h = img.height * scale;
    ctx.drawImage(img, (size - w)/2, (size - h)/2, w, h);

    // Create 25 perfect tiles
    for (let i = 0; i < 25; i++) {
      const row = Math.floor(i / GRID), col = i % GRID;
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = tileSize;
      const c = canvas.getContext('2d');
      c.drawImage(crop, col*tileSize, row*tileSize, tileSize, tileSize, 0, 0, tileSize, tileSize);

      canvas.dataset.orig = i;
      canvas.dataset.pos = i;

      // Create wrapper with checkmark
      const wrapper = document.createElement('div');
      wrapper.className = 'tile-wrapper';
      const checkmark = document.createElement('div');
      checkmark.className = 'checkmark';
      checkmark.textContent = '✓';
      checkmark.style.display = 'none'; // Hidden by default
      wrapper.appendChild(canvas);
      wrapper.appendChild(checkmark);

      let timer = null;
      canvas.onpointerdown = () => {
        timer = setTimeout(() => {
          timer = null;
          const ok = canvas.dataset.pos == canvas.dataset.orig;
          canvas.classList.add(ok ? 'preview-correct' : 'preview-wrong');
          navigator.vibrate?.(50);
        }, 650);
      };
      canvas.onpointerup = canvas.onpointercancel = canvas.onpointerleave = () => {
        if (timer) clearTimeout(timer);
        else setTimeout(() => canvas.classList.remove('preview-correct','preview-wrong'), 300);
        timer = null;
      };
      canvas.onclick = e => { if (timer) { e.preventDefault(); return; } select(canvas); };

      puzzle.appendChild(wrapper);
      tiles.push(canvas);
    }

    // Always show puzzle first
    document.getElementById('puzzleBox').style.display = 'block';
    document.getElementById('originalBox').style.display = 'none';
    document.getElementById('toggleBtn').textContent = 'View Original';

    shuffle();
  };
}

function select(el) {
  const wrapper1 = el.parentElement;
  if (selected === el) { el.classList.remove('selected'); selected = null; return; }
  if (!selected) { selected = el; el.classList.add('selected'); return; }

  const wrapper2 = selected.parentElement;
  [wrapper1.style.gridRow, wrapper2.style.gridRow] = [wrapper2.style.gridRow, wrapper1.style.gridRow];
  [wrapper1.style.gridColumn, wrapper2.style.gridColumn] = [wrapper2.style.gridColumn, wrapper1.style.gridColumn];
  [el.dataset.pos, selected.dataset.pos] = [selected.dataset.pos, el.dataset.pos];
  [el, selected].forEach(update);
  selected.classList.remove('selected'); selected = null;
  checkWin();
}

function update(el) {
  const checkmark = el.parentElement.querySelector('.checkmark');
  if (el.dataset.pos == el.dataset.orig) {
    checkmark.style.display = 'block'; // Show checkmark for correct pieces
    if (!el.classList.contains('done')) {
      el.classList.add('correct-flash','done');
      navigator.vibrate?.([100,50,100]);
      setTimeout(() => el.classList.remove('correct-flash','done'), 1000);
    }
  } else {
    checkmark.style.display = 'none'; // Hide checkmark for incorrect pieces
  }
}

function shuffle() {
  const pos = Array.from({length:25},(_,i)=>i);
  for (let i = pos.length-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [pos[i], pos[j]] = [pos[j], pos[i]];
  }
  tiles.forEach((t, i) => {
    const p = pos[i];
    const wrapper = t.parentElement;
    wrapper.style.gridRow = Math.floor(p/5) + 1;
    wrapper.style.gridColumn = (p%5) + 1;
    t.dataset.pos = p;
    update(t);
  });
}

function checkWin() {
  if (tiles.every(t => +t.dataset.pos === +t.dataset.orig)) {
    alert('Puzzle Solved — Perfect!');
  }
}

// SIMPLEST TOGGLE IN THE WORLD
function toggleView() {
  const p = document.getElementById('puzzleBox');
  const o = document.getElementById('originalBox');
  const b = document.getElementById('toggleBtn');

  if (p.style.display !== 'none') {
    p.style.display = 'none';
    o.style.display = 'block';
    b.textContent = 'Back to Puzzle';
  } else {
    p.style.display = 'block';
    o.style.display = 'none';
    b.textContent = 'View Original';
  }
}

window.onload = init;
window.onresize = init;
</script>
</body>
</html>
